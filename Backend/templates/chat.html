<!DOCTYPE html>
<html>
<head>

  <title>AnyChat - Chat Room</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='chat.css') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>

</head>
<body>
  <h2 style="text-align: center;">ğŸŒ AnyChat Global Chat</h2>
  <h3 style="text-align: center;" id="timer">5:00</h3>
  <p style="text-align: center;">You are chatting as: <strong>{{ nickname }}</strong></p>

  <!-- WRAP THE CHAT IN .chat-wrapper -->
  <div class="chat-wrapper">
    <div class="chat-container">
      <ul id="messages"></ul>

      <!-- keep using .input-container to match CSS -->
   <div class="input-container">
  <input id="msg" type="text" placeholder="Type a message..." />
  <button onclick="sendMessage()">Send</button>
  <button id="emojiBtn">ğŸ˜Š</button>
  
  <!-- move picker inside container -->
  <emoji-picker id="emojiPicker" style="display:none;"></emoji-picker>
</div>


<script>
  const nickname = "{{ nickname }}";  // passed from Flask
  const socket = io();

  socket.on("connect", () => {
    console.log("âœ… Connected!");
    socket.emit("join", { nickname });
  });

  // handle incoming messages
  socket.on("message", (data) => {
    console.log("ğŸ“© Incoming:", data);

    const messages = document.getElementById("messages");
    const atBottom = messages.scrollTop + messages.clientHeight >= messages.scrollHeight - 10;

    let li = document.createElement("li");

    // ensure we handle both {nickname, text} and plain strings (fallback)
    if (typeof data === "string") {
      li.textContent = data;
      li.classList.add("message", "other");
    } else {
      li.textContent = data.text;

      if (data.nickname === nickname) {
        li.classList.add("message", "you");   // your message â†’ right
      } else {
        li.classList.add("message", "other"); // other â†’ left
      }
    }

    messages.appendChild(li);

    // keep scroll at bottom only if user was already at bottom
    if (atBottom) {
      messages.scrollTop = messages.scrollHeight;
    }
  });

  // send message
  function sendMessage() {
    let msg = document.getElementById("msg").value;
    if (msg.trim() !== "") {
      socket.emit("message", { nickname, text: msg });
      document.getElementById("msg").value = "";
    }
  }

  // start countdown
  function timer() {
    let time = 300;
    let timerElement = document.getElementById("timer");
    const countdown = setInterval(() => {
      let minutes = Math.floor(time / 60);
      let seconds = time % 60;

      if (seconds < 10) seconds = "0" + seconds;
      if (minutes < 10) minutes = "0" + minutes;

      timerElement.textContent = `${minutes}:${seconds}`;

      time--;
      if (time < 0) {
        clearInterval(countdown);
        timerElement.textContent = "Time's up!";
      }
    }, 1000);
  }

  // allow Enter key to send
  document.getElementById("msg").addEventListener("keyup", function(event) {
    if (event.key === "Enter") {
      sendMessage();
    }
  });

  // start chat
  socket.on("chat_started", (data) => {
    console.log("â³ Chat started!", data);
    timer();
  });

  const emojiBtn = document.getElementById("emojiBtn");
const emojiPicker = document.getElementById("emojiPicker");
const msgInput = document.getElementById("msg");

// toggle picker visibility
emojiBtn.addEventListener("click", () => {
  emojiPicker.style.display = (emojiPicker.style.display === "none") ? "block" : "none";
});

// insert emoji into text input
emojiPicker.addEventListener("emoji-click", (event) => {
  msgInput.value += event.detail.unicode;
  emojiPicker.style.display = "none"; // auto-hide
});


</script>


</html>
